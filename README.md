# IBKR å†å²æ•°æ®è·å–å·¥å…·

ä¸€ä¸ªé«˜æ•ˆçš„ Interactive Brokers (IBKR) å†å²æ•°æ®æ‰¹é‡è·å–å·¥å…·ï¼Œå…·å¤‡æ™ºèƒ½é¢‘æ§ç®¡ç†åŠŸèƒ½ï¼Œé¿å…è§¦å‘ IBKR API çš„é™åˆ¶ã€‚

## ğŸš€ ç‰¹æ€§

- **æ™ºèƒ½é¢‘æ§ç®¡ç†**: è‡ªåŠ¨éµå®ˆ IBKR API é™åˆ¶ï¼Œé¿å… pacing violation
- **æ‰¹é‡å¤„ç†**: æ”¯æŒå¤§é‡å†å²æ•°æ®çš„æ‰¹é‡è·å–
- **æ–­ç‚¹ç»­ä¼ **: ç¨‹åºä¸­æ–­åå¯ç»§ç»­å¤„ç†å‰©ä½™è¯·æ±‚
- **è¿›åº¦è·Ÿè¸ª**: å®æ—¶æ˜¾ç¤ºå¤„ç†è¿›åº¦å’Œç»Ÿè®¡ä¿¡æ¯
- **å‘½ä»¤è¡Œç•Œé¢**: å‹å¥½çš„ CLI å·¥å…·ï¼Œæ”¯æŒå¤šç§é…ç½®é€‰é¡¹
- **æ™ºèƒ½è°ƒåº¦**: æŒ‰åˆçº¦äº¤æ›¿å¤„ç†ï¼Œä¼˜åŒ–è¯·æ±‚æ•ˆç‡

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚

- **Node.js**: 16.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Bun**: 1.0 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆæ¨èï¼‰
- **æ“ä½œç³»ç»Ÿ**: macOS, Linux, Windows
- **IBKR è¿æ¥**: TWS (Trader Workstation) æˆ– IB Gateway

## ğŸ› ï¸ å®‰è£…æŒ‡å—

### 1. å®‰è£… Bun

#### macOS / Linux

```bash
# ä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬
curl -fsSL https://bun.sh/install | bash

# æˆ–ä½¿ç”¨ Homebrew (macOS)
brew install bun

# æˆ–ä½¿ç”¨åŒ…ç®¡ç†å™¨ (Linux)
# Ubuntu/Debian
curl -fsSL https://bun.sh/install | bash

# Arch Linux
yay -S bun-bin
```

#### Windows

```powershell
# ä½¿ç”¨ PowerShell
powershell -c "irm bun.sh/install.ps1 | iex"

# æˆ–ä½¿ç”¨ Scoop
scoop install bun

# æˆ–ä½¿ç”¨ Chocolatey
choco install bun
```

#### éªŒè¯å®‰è£…

```bash
bun --version
# åº”è¯¥æ˜¾ç¤ºç±»ä¼¼: 1.0.x
```

### 2. å…‹éš†é¡¹ç›®

```bash
git clone <repository-url>
cd ibkr_history_data_fetch
```

### 3. å®‰è£…ä¾èµ–

```bash
bun install
```

## âš™ï¸ ç¯å¢ƒé…ç½®

### 1. IBKR TWS/Gateway é…ç½®

#### å¯åŠ¨ TWS æˆ– IB Gateway

1. ç™»å½•ä½ çš„ IBKR è´¦æˆ·
2. å¯åŠ¨ TWS (Trader Workstation) æˆ– IB Gateway
3. ç¡®ä¿ API è¿æ¥å·²å¯ç”¨

#### é…ç½® API è®¾ç½®

1. åœ¨ TWS ä¸­ï¼š`File > Global Configuration > API > Settings`
2. æˆ–åœ¨ IB Gateway ä¸­ï¼š`Configure > Settings > API`
3. é…ç½®ä»¥ä¸‹è®¾ç½®ï¼š
   - âœ… **Enable ActiveX and Socket Clients**
   - âœ… **Allow connections from localhost only** (æ¨è)
   - ğŸ“ **Socket Port**: é»˜è®¤ 7497 (TWS) æˆ– 4001 (Gateway)
   - âœ… **Master API client ID**: è®¾ç½®ä¸º 0 æˆ–å…¶ä»–å€¼
   - âœ… **Read-Only API**: å¯é€‰å¯ç”¨ï¼ˆæ›´å®‰å…¨ï¼‰

### 2. ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰ï¼š

```bash
# å¤åˆ¶ç¤ºä¾‹é…ç½®æ–‡ä»¶
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```env
# IBKR è¿æ¥é…ç½®
IBKR_HOST=127.0.0.1
IBKR_PORT=7497
IBKR_CLIENT_ID=1
```

### 3. åˆ›å»ºæ•°æ®ç›®å½•

```bash
mkdir -p history_data
```

## ğŸ¯ å¿«é€Ÿå¼€å§‹

### 1. åˆå§‹åŒ–åˆçº¦æ•°æ®

```bash
# åˆå§‹åŒ– MES æœŸè´§åˆçº¦
bun run src/index.ts init -s MES -e CME -c USD -t FUT

# åˆå§‹åŒ–å…¶ä»–åˆçº¦ç¤ºä¾‹
bun run src/index.ts init -s SPY -e SMART -c USD -t STK
```

### 2. è·å–å†å²æ•°æ®

```bash
# ä½¿ç”¨é»˜è®¤è®¾ç½®
bun run src/index.ts history

# è‡ªå®šä¹‰å‚æ•°
bun run src/index.ts history -d "3600 S" -b "5" -w "TRADES" -p "10"
```

## ğŸ“– è¯¦ç»†ä½¿ç”¨è¯´æ˜

### å‘½ä»¤è¡Œæ¥å£

#### æŸ¥çœ‹å¸®åŠ©

```bash
# æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤
bun run src/index.ts --help

# æŸ¥çœ‹ç‰¹å®šå‘½ä»¤å¸®åŠ©
bun run src/index.ts init --help
bun run src/index.ts history --help
```

#### init å‘½ä»¤

åˆå§‹åŒ–åˆçº¦åˆ—è¡¨å’Œæ—¶é—´åˆ†ç‰‡æ•°æ®ã€‚

```bash
bun run src/index.ts init [é€‰é¡¹]
```

**é€‰é¡¹:**

- `-s, --symbol <symbol>`: åˆçº¦ç¬¦å· (å¿…éœ€)
- `-e, --exchange <exchange>`: äº¤æ˜“æ‰€ (å¿…éœ€)
- `-c, --currency <currency>`: è´§å¸ (å¿…éœ€)
- `-t, --secType <secType>`: è¯åˆ¸ç±»å‹ (å¿…éœ€)

**ç¤ºä¾‹:**

```bash
# æœŸè´§åˆçº¦
bun run src/index.ts init -s MES -e CME -c USD -t FUT
bun run src/index.ts init -s NQ -e CME -c USD -t FUT

# è‚¡ç¥¨
bun run src/index.ts init -s AAPL -e SMART -c USD -t STK
bun run src/index.ts init -s TSLA -e NASDAQ -c USD -t STK
```

#### history å‘½ä»¤

æ‰¹é‡è·å–å†å²æ•°æ®ï¼Œå…·å¤‡æ™ºèƒ½é¢‘æ§ç®¡ç†ã€‚

```bash
bun run src/index.ts history [é€‰é¡¹]
```

**é€‰é¡¹:**

- `-d, --duration <duration>`: æ•°æ®æŒç»­æ—¶é—´ (é»˜è®¤: "3600 S")
- `-b, --barSize <barSize>`: K çº¿å¤§å° (é»˜è®¤: "5")
- `-w, --whatToShow <whatToShow>`: æ•°æ®ç±»å‹ (é»˜è®¤: "TRADES")
- `-p, --progressInterval <interval>`: è¿›åº¦æ˜¾ç¤ºé—´éš” (é»˜è®¤: "10")

### é…ç½®é€‰é¡¹è¯¦è§£

#### æ•°æ®æŒç»­æ—¶é—´ (duration)

```bash
# æ—¶é—´æ ¼å¼ç¤ºä¾‹
"60 S"      # 60ç§’
"30 M"      # 30åˆ†é’Ÿ
"2 H"       # 2å°æ—¶
"1 D"       # 1å¤©
"1 W"       # 1å‘¨
"1 M"       # 1ä¸ªæœˆ
"1 Y"       # 1å¹´
```

#### K çº¿å¤§å° (barSize)

| å€¼    | è¯´æ˜    | é€‚ç”¨åœºæ™¯       |
| ----- | ------- | -------------- |
| 1     | 1 ç§’    | è¶…é«˜é¢‘äº¤æ˜“åˆ†æ |
| 5     | 5 ç§’    | é«˜é¢‘äº¤æ˜“åˆ†æ   |
| 10    | 10 ç§’   | çŸ­æœŸæŠ€æœ¯åˆ†æ   |
| 15    | 15 ç§’   | çŸ­æœŸæŠ€æœ¯åˆ†æ   |
| 30    | 30 ç§’   | çŸ­æœŸæŠ€æœ¯åˆ†æ   |
| 60    | 1 åˆ†é’Ÿ  | æ—¥å†…äº¤æ˜“       |
| 300   | 5 åˆ†é’Ÿ  | æ—¥å†…äº¤æ˜“       |
| 900   | 15 åˆ†é’Ÿ | çŸ­æœŸåˆ†æ       |
| 1800  | 30 åˆ†é’Ÿ | ä¸­æœŸåˆ†æ       |
| 3600  | 1 å°æ—¶  | ä¸­æœŸåˆ†æ       |
| 14400 | 4 å°æ—¶  | é•¿æœŸåˆ†æ       |
| 86400 | 1 å¤©    | é•¿æœŸåˆ†æ       |

#### æ•°æ®ç±»å‹ (whatToShow)

| å€¼       | è¯´æ˜     | æ³¨æ„äº‹é¡¹                   |
| -------- | -------- | -------------------------- |
| TRADES   | æˆäº¤æ•°æ® | æœ€å¸¸ç”¨ï¼ŒåŒ…å«æˆäº¤ä»·å’Œæˆäº¤é‡ |
| MIDPOINT | ä¸­é—´ä»·   | (ä¹°ä»·+å–ä»·)/2              |
| BID      | ä¹°ä»·     | éœ€è¦ L1 æ•°æ®æƒé™           |
| ASK      | å–ä»·     | éœ€è¦ L1 æ•°æ®æƒé™           |
| BID_ASK  | ä¹°å–ä»·   | âš ï¸ è®¡ä¸ºåŒå€è¯·æ±‚ï¼          |

## ğŸ“Š è¾“å‡ºæ–‡ä»¶æ ¼å¼

### CSV æ•°æ®æ–‡ä»¶

ä½ç½®: `history_data/{åˆçº¦ç¬¦å·}-{åˆ°æœŸæ—¥}.csv`

æ ¼å¼:

```csv
datetime,open,high,low,close,volume
2023-09-15 08:30:00,4500.25,4501.00,4499.75,4500.50,1250
2023-09-15 08:30:05,4500.50,4500.75,4500.00,4500.25,980
```

### è¿›åº¦æ–‡ä»¶

ä½ç½®: `history_data/contract-list-splices.json`

è‡ªåŠ¨ç»´æŠ¤çš„å¾…å¤„ç†è¯·æ±‚åˆ—è¡¨ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ ã€‚

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. è¿æ¥é—®é¢˜

```
Error: connect ECONNREFUSED 127.0.0.1:7497
```

**è§£å†³æ–¹æ¡ˆ:**

- ç¡®ä¿ TWS/Gateway æ­£åœ¨è¿è¡Œ
- æ£€æŸ¥ç«¯å£é…ç½® (TWS: 7497, Gateway: 4001)
- ç¡®è®¤ API è®¾ç½®å·²å¯ç”¨

#### 2. æƒé™é—®é¢˜

```
Error: No security definition has been found
```

**è§£å†³æ–¹æ¡ˆ:**

- æ£€æŸ¥åˆçº¦ç¬¦å·æ˜¯å¦æ­£ç¡®
- ç¡®è®¤è´¦æˆ·æœ‰ç›¸åº”çš„å¸‚åœºæ•°æ®æƒé™
- éªŒè¯äº¤æ˜“æ‰€å’Œè´§å¸è®¾ç½®

#### 3. é¢‘æ§é—®é¢˜

```
Error: pacing violation
```

**è§£å†³æ–¹æ¡ˆ:**

- ç¨‹åºä¼šè‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
- å¦‚é¢‘ç¹å‡ºç°ï¼Œå¯å¢åŠ åŸºç¡€å»¶è¿Ÿæ—¶é—´

#### 4. æ•°æ®æƒé™é—®é¢˜

```
Error: HMDS query returned no data
```

**è§£å†³æ–¹æ¡ˆ:**

- æ£€æŸ¥è¯·æ±‚çš„æ—¶é—´èŒƒå›´æ˜¯å¦æœ‰æ•ˆ
- ç¡®è®¤è´¦æˆ·æœ‰å†å²æ•°æ®æƒé™
- éªŒè¯åˆçº¦åœ¨è¯·æ±‚æ—¶é—´æ®µå†…æ˜¯å¦å­˜åœ¨

### æ€§èƒ½ä¼˜åŒ–

#### 1. ç½‘ç»œä¼˜åŒ–

- ä½¿ç”¨ç¨³å®šçš„ç½‘ç»œè¿æ¥
- åœ¨äº¤æ˜“æ—¶é—´å¤–è¿è¡Œä»¥å‡å°‘å»¶è¿Ÿ
- è€ƒè™‘ä½¿ç”¨ä¸“ç”¨æœåŠ¡å™¨

#### 2. å‚æ•°è°ƒä¼˜

```bash
# å¯¹äºå¤§é‡æ•°æ®ï¼Œä½¿ç”¨è¾ƒå¤§çš„Kçº¿é—´éš”
bun run src/index.ts history -b "3600" -d "1 D"

# å‡å°‘è¿›åº¦æ˜¾ç¤ºé¢‘ç‡
bun run src/index.ts history -p "50"
```

#### 3. ç³»ç»Ÿèµ„æº

- ç¡®ä¿è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´
- ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
- ä½¿ç”¨ SSD å­˜å‚¨ä»¥æé«˜å†™å…¥æ€§èƒ½

## ğŸ“ å¼€å‘æŒ‡å—

### é¡¹ç›®ç»“æ„

```
ibkr_history_data_fetch/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts          # ä¸»å…¥å£å’ŒCLI
â”‚   â”œâ”€â”€ init.ts           # åˆå§‹åŒ–åŠŸèƒ½
â”‚   â””â”€â”€ history.ts        # å†å²æ•°æ®è·å–
â”œâ”€â”€ history_data/         # æ•°æ®å­˜å‚¨ç›®å½•
â”œâ”€â”€ package.json          # é¡¹ç›®é…ç½®
â”œâ”€â”€ tsconfig.json         # TypeScripté…ç½®
â””â”€â”€ README.md            # æœ¬æ–‡æ¡£
```

### è‡ªå®šä¹‰å¼€å‘

#### æ‰©å±•æ•°æ®å¤„ç†

```typescript
// åœ¨ history.ts ä¸­è‡ªå®šä¹‰æ•°æ®å¤„ç†é€»è¾‘
async function processData(data: any[]) {
  // æ·»åŠ ä½ çš„æ•°æ®å¤„ç†é€»è¾‘
  return data;
}
```

#### æ·»åŠ æ–°çš„æ•°æ®æº

```typescript
// æ‰©å±• HistoryFetchOptions æ¥å£
export interface HistoryFetchOptions {
  // ç°æœ‰é€‰é¡¹...
  customProcessor?: (data: any[]) => Promise<any[]>;
}
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## âš ï¸ å…è´£å£°æ˜

æœ¬å·¥å…·ä»…ç”¨äºæ•™è‚²å’Œç ”ç©¶ç›®çš„ã€‚ä½¿ç”¨æœ¬å·¥å…·è¿›è¡Œäº¤æ˜“å†³ç­–çš„é£é™©ç”±ç”¨æˆ·è‡ªè¡Œæ‰¿æ‹…ã€‚ä½œè€…ä¸å¯¹å› ä½¿ç”¨æœ¬å·¥å…·è€Œäº§ç”Ÿçš„ä»»ä½•æŸå¤±è´Ÿè´£ã€‚

è¯·ç¡®ä¿éµå®ˆ Interactive Brokers çš„æœåŠ¡æ¡æ¬¾å’Œç›¸å…³æ³•å¾‹æ³•è§„ã€‚

## ğŸ“ æ”¯æŒ

å¦‚æœä½ é‡åˆ°é—®é¢˜æˆ–æœ‰å»ºè®®ï¼Œè¯·ï¼š

1. æŸ¥çœ‹ [æ•…éšœæ’é™¤](#-æ•…éšœæ’é™¤) éƒ¨åˆ†
2. æœç´¢ç°æœ‰çš„ [Issues](../../issues)
3. åˆ›å»ºæ–°çš„ Issue å¹¶æä¾›è¯¦ç»†ä¿¡æ¯

---

**Happy Trading! ğŸ“ˆ**
