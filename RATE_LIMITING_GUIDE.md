# IBKR 频控优化指南

## 问题描述

Interactive Brokers (IBKR) 对历史数据请求有严格的频控限制：

1. **15秒内不能进行相同的历史数据请求**
2. **2秒内对同一合约、交易所和tick类型不能超过6次请求**
3. **10分钟内总请求数不能超过60次**
4. **BID_ASK数据请求计为双倍**

## 解决方案

### 1. 智能频控管理器 (RateLimiter)

新的 `RateLimiter` 类实现了以下功能：

- **请求去重**: 自动跳过15秒内的重复请求
- **合约级别控制**: 确保2秒内同一合约请求不超过5次（留1次缓冲）
- **全局请求限制**: 10分钟内请求不超过50次（留10次缓冲）
- **最小间隔控制**: 每次请求间隔至少3秒

### 2. 智能批处理

- **按合约分组**: 将请求按合约分组，避免连续请求同一合约
- **交替处理**: 轮流处理不同合约的请求，分散频控压力
- **动态延迟**: 根据频控状态动态调整请求间隔

### 3. 增强的错误处理

- **指数退避**: 触发频控时使用指数退避策略重试
- **多种错误类型处理**: 区分频控、合约不存在、无数据等不同错误
- **最大重试限制**: 避免无限重试

### 4. 进度跟踪

- **实时进度显示**: 每处理10个请求显示一次进度
- **详细统计**: 显示成功、跳过、错误的请求数量
- **预计完成时间**: 根据请求数量估算完成时间

## 使用方法

```bash
# 运行优化后的历史数据获取
bun run src/history.ts
```

## 性能改进

### 优化前
- 固定3秒间隔，容易触发频控
- 无请求去重，可能重复请求
- 简单的10秒等待重试
- 无进度跟踪

### 优化后
- 智能频控管理，主动避免违规
- 自动跳过重复和无效请求
- 指数退避重试策略
- 详细的进度跟踪和统计
- 按合约交替处理，提高效率

## 预期效果

1. **大幅减少频控违规**: 通过主动管理避免触发限制
2. **提高处理效率**: 智能调度减少不必要的等待
3. **更好的用户体验**: 实时进度显示和错误处理
4. **断点续传**: 程序中断后可以继续处理剩余请求

## 监控建议

运行时注意观察：
- 是否还有 "pacing violation" 错误
- 进度显示是否正常
- 错误率是否在可接受范围内

如果仍然频繁触发频控，可以考虑：
- 增加基础延迟时间（当前3秒）
- 降低并发处理的合约数量
- 进一步优化请求调度策略
